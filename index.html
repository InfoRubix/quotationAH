<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Quotation Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-section { border-bottom: 1px solid #e5e7eb; padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
        .form-section:last-child { border-bottom: none; margin-bottom: 0; }
        .preview-header { text-align: center; margin-bottom: 1.5rem; }
        .preview-header h1 { font-weight: 700; font-size: 1.5rem; margin-bottom: 0.25rem; }
        .preview-header p { font-size: 0.875rem; color: #4b5563; line-height: 1.4; }
        .preview-details-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; margin-bottom: 1.5rem; }
        .preview-details-grid dt { font-weight: 600; color: #374151; }
        .preview-table th, .preview-table td { padding: 0.75rem 0.5rem; text-align: left; font-size: 0.875rem; word-wrap: break-word; }
        .preview-table th { background-color: #f3f4f6; }
        .total-row td { font-weight: 700; border-top: 2px solid #e5e7eb; }
        .section-title-row td { font-weight: 600; background-color: #f9fafb; padding-top: 1rem; }
        #status-message { transition: opacity 0.5s; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 lg:p-8">
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center">Legal Quotation Generator</h1>
            <p class="text-center text-gray-500 mt-2">Create and export professional quotations for conveyancing matters.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Form Section -->
            <div class="bg-white p-6 lg:p-8 rounded-2xl shadow-lg">
                <form id="quote-form" onsubmit="event.preventDefault();">
                    <div class="form-section">
                        <h2 class="text-xl font-bold mb-4 text-gray-700">Client & Property Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="client-name" class="block text-sm font-medium text-gray-700">Client Name</label>
                                <input type="text" id="client-name" placeholder="e.g., John Doe" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="property-location" class="block text-sm font-medium text-gray-700">Property State</label>
                                <select id="property-location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                    <option selected>Selangor</option><option>Johor</option><option>Kuala Lumpur</option><option>Kedah</option><option>Kelantan</option><option>Labuan</option><option>Melaka</option><option>Negeri Sembilan</option><option>Pahang</option><option>Penang</option><option>Perak</option><option>Perlis</option><option>Putrajaya</option><option>Sabah</option><option>Sarawak</option><option>Terengganu</option>
                                </select>
                            </div>
                             <div class="md:col-span-2">
                                <label for="property-value" class="block text-sm font-medium text-gray-700">Purchase Price (RM)</label>
                                <input type="number" id="property-value" placeholder="e.g., 470000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="loan-amount" class="block text-sm font-medium text-gray-700">Loan Amount (RM)</label>
                                <input type="number" id="loan-amount" placeholder="e.g., 400000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2 class="text-xl font-bold mb-4 text-gray-700">Fees & Disbursements</h2>
                        <div id="services-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                    </div>

                    <div class="mt-6 space-y-3">
                        <button type="button" id="main-action-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                            Generate PDF & Save to Sheet
                        </button>
                        <button type="button" id="new-quote-button" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-colors duration-200">
                            New Quotation
                        </button>
                    </div>
                    <div id="status-message" class="mt-4 text-center text-sm font-medium text-gray-600 opacity-0"></div>
                </form>
            </div>

            <!-- Preview Section -->
            <div id="preview-container" class="bg-white p-6 lg:p-8 rounded-2xl shadow-lg overflow-hidden">
                <div class="preview-header">
                    <h1>ASIAH & HISAM</h1>
                    <p>Advocates & Solicitors. Peguamcara & Peguambela.<br>
                    No. 2-21, Jalan 8/35 Seri Bangi, Seksyen 8, 43650 Bandar Baru Bangi, Selangor, Malaysia<br>
                    Tel: +603-89124455 | Fax: +603-89124477 | Email: ahsentral@gmail.com</p>
                </div>
                <h2 class="text-center font-bold text-2xl mb-4 text-gray-800" style="letter-spacing: 2px;">QUOTATION</h2>
                <div class="preview-details-grid">
                    <dt>To:</dt><dd id="preview-client-name">N/A</dd>
                    <dt>Matter:</dt><dd>Conveyancing (General)</dd>
                    <dt>Property:</dt><dd id="preview-property-location">N/A</dd>
                    <dt>Purchase Price:</dt><dd id="preview-purchase-price">RM 0.00</dd>
                    <dt>Loan Amount:</dt><dd id="preview-loan-amount">RM 0.00</dd>
                    <dt>Quotation No.:</dt><dd id="preview-quote-no">Q-XXXXX</dd>
                    <dt>Quotation Date:</dt><dd id="preview-quote-date">DD/MM/YYYY</dd>
                    <dt>Tax Reg. No.:</dt><dd>W24-1809-32100013</dd>
                </div>
                <table class="w-full preview-table table-fixed">
                    <colgroup>
                        <col style="width: 40%;"><col style="width: 15%;"><col style="width: 15%;"><col style="width: 15%;"><col style="width: 15%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>Description</th><th class="text-right">Tax (%)</th><th class="text-right">Charges</th><th class="text-right">Tax</th><th class="text-right">Total (RM)</th>
                        </tr>
                    </thead>
                    <tbody id="preview-table-body"></tbody>
                </table>
                <div class="mt-6 text-xs text-gray-500">
                    <p class="font-bold">Remarks:</p><p id="preview-remarks">-</p>
                    <p class="mt-4 break-words"><strong>Disclaimer:</strong> The issued quotation not to be treated as our final invoice and it is subjected to your confirmation prior to rendering the above legal services to you.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function () {
            // IMPORTANT: Replace this with your actual Google Apps Script Web App URL.
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzef56sWVIHhl-gazM_BDK7mkIDrpmy2zB9assvTAZ1RjxN3wIKuNfxFuILO_u4y422cg/exec";

            const TAX_RATE = 0.08;
            const ALL_SERVICES = [
                { id: 'spa_legal_fee', description: 'Sale & Purchase Agreement Legal Fees', type: 'professional', auto: true, calc: 'calcSpaLegalFee', taxable: true, default_checked: true },
                { id: 'loan_legal_fee', description: 'Loan Agreement Legal Fees', type: 'professional', auto: true, calc: 'calcLoanLegalFee', taxable: true, default_checked: true },
                { id: 'mot_stamp_duty', description: 'Stamp Duty on Memorandum of Transfer (MOT/14A)', type: 'disbursement', auto: true, calc: 'calcMotStampDuty', taxable: false, default_checked: true },
                { id: 'loan_stamp_duty', description: 'Stamp Duty on Loan Agreement', type: 'disbursement', auto: true, calc: 'calcLoanStampDuty', taxable: false, default_checked: true },
                { id: 'ckht2a', description: 'Filing CKHT 2A', type: 'professional', price: 400, taxable: true },
                { id: 'ckht1', description: 'Filing CKHT 1', type: 'professional', price: 300, taxable: true },
                { id: 'ckht3', description: 'Filing CKHT 3', type: 'professional', price: 200, taxable: true },
                { id: 'stat_dec', description: 'Statutory Declaration', type: 'professional', price: 150, taxable: true },
                { id: 'consent_transfer', description: 'Consent to Transfer', type: 'professional', price: 500, taxable: true },
                { id: 'consent_charge', description: 'Consent to Charge', type: 'professional', price: 500, taxable: true },
                { id: 'drr', description: 'Deed of Receipt & Reassignment', type: 'professional', price: 400, taxable: true },
                { id: 'caveat', description: 'Entry & Withdrawal of Private Caveat', type: 'professional', price: 500, taxable: true },
                { id: 'lphs_consent', description: 'LPHS Consent', type: 'professional', price: 150, taxable: true },
                { id: 'transport', description: 'Transportation & Courier Charges', type: 'disbursement_taxable', price: 500, taxable: true, default_checked: true },
                { id: 'printing', description: 'Xerox/Printing/Fax/Telephone/Postage', type: 'disbursement_taxable', price: 450, taxable: true, default_checked: true },
                { id: 'misc', description: 'Miscellaneous', type: 'disbursement_taxable', price: 100, taxable: true, default_checked: true },
                { id: 'spa_stamp', description: 'Stamp Duty on SPA', type: 'disbursement', price: 40, taxable: false },
                { id: 'sd_stamp', description: 'Stamp on Statutory Declaration (SD)', type: 'disbursement', price: 100, taxable: false },
                { id: 'bankruptcy_search', description: 'Bankruptcy/Winding Up Search', type: 'disbursement', price: 100, taxable: false },
                { id: 'land_search', description: 'Official Land Search', type: 'disbursement', price: 300, taxable: false },
                { id: 'dev_confirm', description: 'Developer\'s Confirmation (Sec.22D HDA)', type: 'disbursement', price: 150, taxable: false },
                { id: 'affirm_sd', description: 'Affirmation of Statutory Declaration', type: 'disbursement', price: 100, taxable: false },
                { id: 'ctc_doc', description: 'CTC Document Fee', type: 'disbursement', price: 250, taxable: false },
                { id: 'reg_mot', description: 'Registration Fees on MOT (Selangor)', type: 'disbursement', price: 200, taxable: false },
                { id: 'reg_charge', description: 'Registration Fees on Memorandum of Charge', type: 'disbursement', price: 140, taxable: false },
                { id: 'attestation', description: 'Attestation (for Johor)', type: 'disbursement', price: 500, taxable: false },
            ];
            
            const calculations = {
                calcSpaLegalFee: (val) => {
                    if (!val || val <= 0) return 0; let fee = 0;
                    if (val <= 500000) { fee = val * 0.0125; } 
                    else if (val <= 1000000) { fee = (500000 * 0.0125) + ((val - 500000) * 0.01); } 
                    else if (val <= 3000000) { fee = (500000 * 0.0125) + (500000 * 0.01) + ((val - 1000000) * 0.008); } 
                    else { fee = (500000 * 0.0125) + (500000 * 0.01) + (2000000 * 0.008) + ((val - 3000000) * 0.006); }
                    return Math.max(fee, 500);
                },
                calcLoanLegalFee: (val) => calculations.calcSpaLegalFee(val),
                calcMotStampDuty: (val) => {
                    if (!val || val <= 0) return 0; let duty = 0;
                    if (val <= 100000) { duty = val * 0.01; } 
                    else if (val <= 500000) { duty = (100000 * 0.01) + ((val - 100000) * 0.02); } 
                    else if (val <= 1000000) { duty = (100000 * 0.01) + (400000 * 0.02) + ((val - 500000) * 0.03); } 
                    else { duty = (100000 * 0.01) + (400000 * 0.02) + (500000 * 0.03) + ((val - 1000000) * 0.04); }
                    return duty;
                },
                calcLoanStampDuty: (val) => val > 0 ? val * 0.005 : 0,
            };

            const form = document.getElementById('quote-form');
            const servicesList = document.getElementById('services-list');

            function formatCurrency(num) { return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }

            function getQuoteData() {
                const propertyValue = parseFloat(document.getElementById('property-value').value) || 0;
                const loanAmount = parseFloat(document.getElementById('loan-amount').value) || 0;
                const selectedServices = [];
                let totalCharges = 0, totalTax = 0;

                ALL_SERVICES.filter(s => s.auto).forEach(service => {
                    const value = (service.id.includes('spa') || service.id.includes('mot')) ? propertyValue : loanAmount;
                    if (value > 0) {
                        const charge = calculations[service.calc](value);
                        if (charge > 0) selectedServices.push({ ...service, price: charge });
                    }
                });

                document.querySelectorAll('.service-checkbox:checked').forEach(checkbox => {
                    const serviceId = checkbox.id;
                    const service = ALL_SERVICES.find(s => s.id === serviceId);
                    const price = parseFloat(document.querySelector(`.service-price-input[data-id="${serviceId}"]`).value) || 0;
                    selectedServices.push({ ...service, price });
                });
                
                selectedServices.forEach(item => {
                    const charge = item.price;
                    const tax = item.taxable ? charge * TAX_RATE : 0;
                    totalCharges += charge;
                    totalTax += tax;
                });

                return {
                    clientName: document.getElementById('client-name').value || 'N/A',
                    propertyValue,
                    loanAmount,
                    propertyLocation: document.getElementById('property-location').value,
                    services: selectedServices,
                    totalCharges,
                    totalTax,
                    grandTotal: totalCharges + totalTax
                };
            }

            function updateQuotePreview() {
                const data = getQuoteData();
                document.getElementById('preview-client-name').textContent = data.clientName;
                document.getElementById('preview-property-location').textContent = data.propertyLocation;
                document.getElementById('preview-purchase-price').textContent = `RM ${formatCurrency(data.propertyValue)}`;
                document.getElementById('preview-loan-amount').textContent = `RM ${formatCurrency(data.loanAmount)}`;
                const date = new Date();
                document.getElementById('preview-quote-date').textContent = date.toLocaleDateString('en-GB');
                document.getElementById('preview-quote-no').textContent = `Q${date.getTime().toString().slice(-5)}`;
                const tableBody = document.getElementById('preview-table-body');
                tableBody.innerHTML = '';

                const renderSection = (title, type) => {
                    const items = data.services.filter(s => s.type === type);
                    if (items.length === 0) return;
                    tableBody.innerHTML += `<tr class="section-title-row"><td colspan="5">${title}</td></tr>`;
                    items.forEach(item => {
                        const charge = item.price;
                        const tax = item.taxable ? charge * TAX_RATE : 0;
                        tableBody.innerHTML += `
                            <tr>
                                <td>${item.description}</td>
                                <td class="text-right">${item.taxable ? (TAX_RATE * 100).toFixed(0) + '%' : '0%'}</td>
                                <td class="text-right">${formatCurrency(charge)}</td>
                                <td class="text-right">${formatCurrency(tax)}</td>
                                <td class="text-right">${formatCurrency(charge + tax)}</td>
                            </tr>`;
                    });
                };
                renderSection('Professional Fees', 'professional');
                renderSection('Disbursements with Tax', 'disbursement_taxable');
                renderSection('Disbursements', 'disbursement');
                tableBody.innerHTML += `
                    <tr class="total-row">
                        <td class="text-right" colspan="2">TOTAL:</td>
                        <td class="text-right">${formatCurrency(data.totalCharges)}</td>
                        <td class="text-right">${formatCurrency(data.totalTax)}</td>
                        <td class="text-right">${formatCurrency(data.grandTotal)}</td>
                    </tr>`;
            }

            function mainAction() {
                const jsPDF = window.jspdf.jsPDF;
                const doc = new jsPDF();
                const data = getQuoteData();
                const date = new Date();
                const quoteNo = `Q${date.getTime().toString().slice(-5)}`;
                const quoteDate = date.toLocaleDateString('en-GB');
                
                // --- PDF Generation ---
                doc.setFontSize(16).setFont('helvetica', 'bold').text('ASIAH & HISAM', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                doc.setFontSize(9).setFont('helvetica', 'normal');
                doc.text('Advocates & Solicitors. Peguamcara & Peguambela.', doc.internal.pageSize.getWidth() / 2, 26, { align: 'center' });
                doc.text('No. 2-21, Jalan 8/35 Seri Bangi, Seksyen 8, 43650 Bandar Baru Bangi, Selangor, Malaysia', doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });
                doc.text('Tel: +603-89124455 | Fax: +603-89124477 | Email: ahsentral@gmail.com', doc.internal.pageSize.getWidth() / 2, 34, { align: 'center' });
                doc.setFontSize(18).setFont('helvetica', 'bold').text('QUOTATION', doc.internal.pageSize.getWidth() / 2, 45, { align: 'center' });
                const startY = 55;
                doc.setFontSize(10);
                const details = [
                    ['To:', data.clientName, 'Quotation No.:', quoteNo],
                    ['Matter:', 'Conveyancing (General)', 'Quotation Date:', quoteDate],
                    ['Property:', data.propertyLocation, 'Tax Reg. No.:', 'W24-1809-32100013'],
                    ['Purchase Price:', `RM ${formatCurrency(data.propertyValue)}`],
                    ['Loan Amount:', `RM ${formatCurrency(data.loanAmount)}`],
                ];
                details.forEach((row, i) => {
                    doc.setFont('helvetica', 'bold').text(row[0], 14, startY + (i * 5));
                    doc.setFont('helvetica', 'normal').text(row[1], 45, startY + (i * 5));
                    if (row[2]) {
                        doc.setFont('helvetica', 'bold').text(row[2], 120, startY + (i * 5));
                        doc.setFont('helvetica', 'normal').text(row[3], 155, startY + (i * 5));
                    }
                });
                const tableData = [];
                const addSectionToPdf = (title, type) => {
                    const items = data.services.filter(s => s.type === type);
                    if (items.length === 0) return;
                    tableData.push([{ content: title, colSpan: 5, styles: { fontStyle: 'bold', fillColor: [249, 250, 251] } }]);
                    items.forEach(item => {
                        const charge = item.price;
                        const tax = item.taxable ? charge * TAX_RATE : 0;
                        tableData.push([
                            item.description,
                            { content: item.taxable ? `${(TAX_RATE * 100).toFixed(0)}%` : '0%', styles: { halign: 'right' } },
                            { content: formatCurrency(charge), styles: { halign: 'right' } },
                            { content: formatCurrency(tax), styles: { halign: 'right' } },
                            { content: formatCurrency(charge + tax), styles: { halign: 'right' } }
                        ]);
                    });
                };
                addSectionToPdf('Professional Fees', 'professional');
                addSectionToPdf('Disbursements with Tax', 'disbursement_taxable');
                addSectionToPdf('Disbursements', 'disbursement');
                tableData.push([
                    { content: 'TOTAL:', colSpan: 2, styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatCurrency(data.totalCharges), styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatCurrency(data.totalTax), styles: { halign: 'right', fontStyle: 'bold' } },
                    { content: formatCurrency(data.grandTotal), styles: { halign: 'right', fontStyle: 'bold' } }
                ]);
                
                doc.autoTable({
                    head: [['Description', 'Tax (%)', 'Charges', 'Tax', 'Total (RM)']],
                    body: tableData,
                    startY: startY + 30,
                    theme: 'grid',
                    headStyles: { fillColor: [243, 244, 246], textColor: 20, fontStyle: 'bold' },
                    styles: { fontSize: 9, cellPadding: 2.5 },
                    columnStyles: { 0: { cellWidth: 80 } }
                });

                const finalY = doc.autoTable.previous.finalY;
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold').text('Disclaimer:', 14, finalY + 10);
                doc.setFont('helvetica', 'normal').text('The issued quotation not to be treated as our final invoice and it is subjected to your confirmation prior to rendering the above legal services to you.', 14, finalY + 14, { maxWidth: 180 });
                doc.save(`Quotation-${data.clientName.replace(/\s/g, '_')}-${quoteNo}.pdf`);
                
                // --- Google Sheet Saving ---
                const mainButton = document.getElementById('main-action-button');
                const statusMessage = document.getElementById('status-message');
                mainButton.disabled = true;
                statusMessage.style.opacity = 1;
                statusMessage.textContent = 'PDF downloaded. Now saving to Google Sheet...';
                statusMessage.style.color = '#4b5563';

                const submissionData = {
                    quoteNo: quoteNo,
                    date: quoteDate,
                    clientName: data.clientName,
                    propertyLocation: data.propertyLocation,
                    propertyValue: data.propertyValue,
                    loanAmount: data.loanAmount,
                    totalCharges: data.totalCharges,
                    totalTax: data.totalTax,
                    grandTotal: data.grandTotal
                };

                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    redirect: 'follow', 
                    body: JSON.stringify(submissionData)
                })
                .then(() => {
                    statusMessage.textContent = "Data sent successfully! Please check your Google Sheet.";
                    statusMessage.style.color = 'green';
                })
                .catch(error => {
                    statusMessage.textContent = 'Error sending data: ' + error.message;
                    statusMessage.style.color = 'red';
                })
                .finally(() => {
                    mainButton.disabled = false;
                    setTimeout(() => { statusMessage.style.opacity = 0; }, 5000);
                });
            }

            function resetForm() {
                document.getElementById('quote-form').reset();
                updateQuotePreview();
            }

            // --- INITIALIZATION ---
            ALL_SERVICES.filter(s => !s.auto).forEach(service => {
                const isChecked = service.default_checked ? 'checked' : '';
                servicesList.innerHTML += `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                        <div class="flex items-center w-full">
                            <input id="${service.id}" name="${service.id}" type="checkbox" ${isChecked} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 service-checkbox">
                            <label for="${service.id}" class="ml-3 text-sm text-gray-600 flex-grow">${service.description}</label>
                        </div>
                        <input type="number" value="${service.price}" class="w-24 text-right rounded-md border-gray-300 shadow-sm text-sm service-price-input" data-id="${service.id}">
                    </div>`;
            });
            updateQuotePreview();
            form.addEventListener('input', updateQuotePreview);
            document.getElementById('main-action-button').addEventListener('click', mainAction);
            document.getElementById('new-quote-button').addEventListener('click', resetForm);
        });
    </script>
</body>
</html>
